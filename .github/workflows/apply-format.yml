name: Apply Formatting

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  apply-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Install shfmt (prebuilt)
        run: |
          set -euo pipefail
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
            URL="https://github.com/mvdan/sh/releases/latest/download/shfmt_linux_amd64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            URL="https://github.com/mvdan/sh/releases/latest/download/shfmt_linux_arm64"
          else
            echo "Unsupported architecture: $ARCH" >&2
            exit 1
          fi
          curl -sSL -o /usr/local/bin/shfmt "$URL"
          chmod +x /usr/local/bin/shfmt

      - name: Install Python tools
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install black
        run: |
          python3 -m pip install --upgrade pip
          pip3 install black

      - name: Apply shfmt
        run: |
          # Apply shfmt formatting with project options
          find . -name "*.sh" -not -path "*/node_modules/*" -print0 | xargs -0 shfmt -w -i 4 -ci || true

      - name: Apply black
        run: |
          python3 -m black . || true

      - name: Show git status
        run: |
          git status --porcelain

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet; then
            git add -A
            git commit -m "chore: apply code formatting (shfmt/black)" || echo "No commit needed"
            # Push to the current branch that triggered the PR
            BRANCH_NAME=$(echo "${{ github.head_ref }}")
            if [ -n "$BRANCH_NAME" ]; then
              git push origin "HEAD:$BRANCH_NAME"
            else
              # Fallback: push current branch
              git push
            fi
          else
            echo "No formatting changes to commit."
          fi
