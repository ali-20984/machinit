#!/usr/bin/env bash
# Lightweight zsh wrapper for git completion.
# Uses system-provided git bash completion if available; this mirrors
# upstream git's recommended approach.
# Source: https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.zsh

#compdef git gitk

zstyle -T ':completion:*:*:git:*' tag-order && \
  zstyle ':completion:*:*:git:*' tag-order 'common-commands'

zstyle -s ":completion:*:*:git:*" script script
if [ -z "$script" ]; then
  local -a locations
  local e bash_completion

  # try pkg-config for bash-completion location
  bash_completion=$(pkg-config --variable=completionsdir bash-completion 2>/dev/null) || \
    bash_completion='/usr/share/bash-completion/completions/'

  locations=(
    "$(dirname ${funcsourcetrace[1]%:*})/git-completion.bash"
    "$HOME/.local/share/bash-completion/completions/git"
    "$bash_completion/git"
    '/etc/bash_completion.d/git'
  )
  for e in "${locations[@]}"; do
    test -f "$e" && script="$e" && break
  done
fi

if [ -n "$script" ]; then
  # temporarily disable 'complete' function wrappers while sourcing
  local old_complete
  old_complete="$functions[complete]"
  functions[complete]=:
  GIT_SOURCING_ZSH_COMPLETION=1 . "$script"
  functions[complete]="$old_complete"
fi

return 0
