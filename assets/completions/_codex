#!/usr/bin/env bash
# Curated OpenAI Codex CLI completion
# Prefers codex's built-in completion when available; otherwise provides a
# helpful fallback covering global flags, subcommands, and exec-mode options.
#compdef codex

if command -v codex >/dev/null 2>&1; then
  # prefer the tool-produced completion if supported
  if out=$(codex completion zsh 2>/dev/null); then
    # shellcheck disable=SC2148
    eval "$out" 2>/dev/null || true
    return 0
  fi
fi

local -a commands
commands=(
  'exec:Run a single prompt/task non-interactively (automation mode)'
  'login:Authenticate the CLI (ChatGPT OAuth / API key)'
  'logout:Remove stored authentication'
  'resume:Resume a previous interactive session (optional session id)'
  'apply:Apply the latest diff generated by a cloud task to working tree'
  'sandbox:Run commands inside a restricted sandbox (test risky actions)'
  'completion:Generate shell completion scripts'
  'mcp:Manage MCP (Model Context Protocol) servers / integrations'
  'mcp-server:Run Codex as an MCP server over stdio'
  'app-server:Launch a local debug app-server for extension dev'
  'cloud:Interact with Codex Cloud tasks (list/submit/apply)'
  'help:Show help & docs'
)

_describe 'codex command' commands && return 0

# Helper completions
_codex_images() { _files -g '*.(png|jpg|jpeg|gif|webp|bmp|svg)'; }
_codex_dirs() { _directories; }

# Slash / in-session commands for interactive TUI (prefix '/')
_codex_slash() {
  local -a slash
  slash=(
    '/model:Switch the AI model used by session'
    '/review:Trigger a review / generate patch diffs'
    '/status:Show current session configuration and stats'
    '/approvals:Adjust approval behaviour for this session'
    '/add-dir:Add a directory to trusted write paths'
    '/cwd:Change session working directory'
    '/help:Show session commands help'
    '/usage:Show usage / quota / session stats'
    '/feedback:Send feedback on suggestions'
  )
  _describe 'slash command' slash
}

# Main argument parsing â€” global flags + exec-specific options support
_arguments -s \
  '(-h --help)'{-h,--help}'[Show help]' \
  '(-V --version)'{-V,--version}'[Show version]' \
  '1:subcommand:->subcmd' \
  '*:args:->args'

case $state in
  subcmd)
    _describe 'codex command' commands && return 0
    ;;

  args)
    # If interactive slash commands are typed, provide them
    if [[ $words[CURRENT] == /* ]]; then
      _codex_slash && return 0
    fi

    # If first word is exec, provide exec-specific flags
    case $words[1] in
      exec|e)
        _arguments -s \
          '(-h --help)'{-h,--help}'[show help]' \
          '--[PROMPT]: :prompt string' \
          '(-i --image)'{-i,--image}'[Attach image(s)]' \
          '--image=[file]:image file:_codex_images' \
          '(-m --model)'{-m,--model}'[Override model]:model' \
          '--oss[Use local OSS model backend]' \
          '(--sandbox -s)'{--sandbox,-s}'[Sandbox policy]:policy:(read-only workspace-write danger-full-access)' \
          '(-p --profile)'{-p,--profile}'[Use named profile]:profile:_files' \
          '--full-auto[Convenience: workspace-write + approval-on-failure]' \
          '--dangerously-bypass-approvals-and-sandbox[Bypass approvals and sandboxing (DANGEROUS)]' \
          '(-C --cd)'{-C,--cd}'[Set working directory]:dir:_codex_dirs' \
          '--skip-git-repo-check[Allow execution outside a git repo]' \
          '--output-schema=[file]:path:_files' \
          '--json[Emit newline-delimited JSON events]' \
          '--experimental-json[Emit experimental JSON format]' \
          '(-o --output-last-message)'{-o,--output-last-message}'[Write assistant final message to file]:file:_files' && return 0
        ;;

      login|logout|resume|apply|sandbox|mcp|mcp-server|app-server|cloud)
        # For these we offer file/dir completions where relevant
        if [[ $words[1] == apply || $words[1] == app-server || $words[1] == mcp-server ]]; then
          _files && return 0
        fi
        ;;

      completion)
        _arguments '1: :_(options)'
        ;;

      *)
        # fall back to file completion for any argument that looks like a path
        _files && return 0
        ;;
    esac
    ;;
esac

return 0
